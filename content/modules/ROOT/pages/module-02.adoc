= Section 3 - Splunk

In this lab environment, we've included üîç Splunk to integrate with üì° Event Driven Ansible (EDA). Splunk collects and indexes log files and other data from network sources in real-time. This indexed data is then stored in a way that allows for incredibly fast and flexible searching and analysis. From a splunk search for OSPF related events, we can create a splunk alert to send webhooks or kafka topics to EDA. 

Think of Splunk as an observability tool. 

[quote]
üí° Observability tools, such as Splunk, Prometheus, Grafana, Dynatrace, and others, provide deep insights into the health and performance of IT systems. They excel at collecting metrics, logs, and traces to identify when something is wrong. However, they traditionally rely on human intervention to interpret the alerts and take corrective action. This is where Ansible EDA steps in, creating a powerful synergy.

== Splunk Setup and Router Configuration

=== Red Hat + Splunk
The integration between Red Hat Ansible Automation Platform and Splunk creates a powerful, two-way bridge that transforms IT operations by connecting Splunk's deep data analysis and observability with Ansible's robust automation capabilities. This is achieved through an add-on that allows for a seamless flow of information. 

image::redhat_splunk.png[Red Hat + Splunk, 100%]

=== Accessing Splunk
[cols="2,2", options="header"]
|===
| Component
| Value

| Splunk URL
| `{splunk_url}`[Splunk,window=_blank]

| Username
| admin

| Password
| `{ssh_password}`
|===

	1.	Open Splunk using the above details ( use incognito window if needed )
	2.	Login using the credentials provided

=== Data Inputs
In Splunk, üîç "data inputs" are the various methods and sources from which the platform can ingest data for indexing, searching, and analysis. They are the pathways that feed raw machine data into the Splunk system.
  	
Once logged into Splunk, click on the settings at the top of the screen and data inputs

image::data_inputs.png[Data Inputs, 250%]

==== TCP Port 5514
Splunk has been pre-loaded to open TCP port 5514. We simply need to add a data input to receive Cisco IOS syslogs using this port.

Step1:  Add a new TCP input


image::tcp_1.png[Add TCP, 200%]

Step2: Click on "New Local TCP"

image::tcp2.png[Add TCP, 200%]

Step3: Select TCP, port 5514, and click "next" 

image::tcp_3.png[Add TCP, 200%]

Step4: ‚öôÔ∏è Configure the following input settings

=== Input Settings
[cols="2,2", options="header"]
|===
| Component
| Value

| Source Type
| cisco:ios

| App Context
| Cisco Networks (cisco:ios)

| Host 
| IP
|===

image::tcp_4.png[Add TCP, 100%]

Step5: Validate your configuration and submit

image::tcp_5.png[Add TCP, 150%]

=== Cisco Routers 

This lab includes two Cisco Cat8000v routers. Both routers use interface tunnel0 for the OPSF connection. 

==== Router setup playbook
This job template, "Network-Router-Setup," automates the initial configuration of network routers.

In addition to establishing OSPF routing, this playbook now configures the target device (e.g., cisco-rtr1) to send all syslog messages to Splunk over TCP port 5514 for centralized logging and monitoring.

Access AAP and run üöÄ the job-template

image::router_setup.png[Router Setup, 150%]

=== Verify Syslogs
Step1: After the Cisco router setup completes, return to splunk and click on the Cisco Networks App

image::cisco_networks.png[Cisco networks, 150%]

Step2: Enter the routing dashboard

image::routing_dashboard1.png[Routing Dash, 150%]

Step3: Verify that there is an entry of an OSPF event with a full adjacency 

image::routing_dashboard2.png[Routing Dash, 250%]

=== ‚öôÔ∏è Configure an Alert üì£
In splunk we can create an alert from a üîç search. A Splunk search is when you manually run a query to find and analyze information in your data.

An alert is simply that search saved to run automatically if the search results meet a trigger condition you set (like "%OSPF-5-ADJCHG: Process 1, Nbr 192.168.2.2 on Tunnel0 from FULL to DOWN"), Splunk automatically performs an action, such as sending a webhook to EDA.

Step1: Access the Splunk üîç search field

image::search1.png[Search, 150%]

[quote]
üõë You will return to this browser tab after completing the next step

Step2: Create an OPSF neighbor down event
Access cisco-rtr1 from the bastion console to shut down interface tunnel0

image::bastion.png[bastion, 150%]

* SSH password=`{ssh_password}` 
* SSH into cisco-rtr1 and add the following commands
 
[source, BASH]
----
ssh admin@cisco-rtr1
config t
int tu 0
shut
----

Step3: Return to the Splunk search

paste in the following line and search: 

[source, BASH]
----
 %OSPF-5-ADJCHG: Process 1, Nbr 192.168.2.2 on Tunnel0 from FULL to DOWN
----

image::search2.png[Search, 150%]
image::search-3.png[Search, 150%]


Step4: Save as an Alert (ospf-neighbor)

image::save_as_alert.png[Save As, 150%]

Complete the pop-up screen for save as an alert

=== Alert Settings
[cols="2,2", options="header"]
|===
| Title
| ospf-neighbor

| Permissions
| Shared in App

| Alert type
| Real-time

| Add Actions
| Add to Triggered Alerts
| Add Actions
| Webhook
    | URL
    | http://controller.example.com
|===

image::save_as_alert2.png[Save As, 100%]

=== üì° Event Driven Ansible Addon (Reference Only)
For this lab environment we are using a simple webhook. However, for a more secure webhook, Splunk offers the Ansible EDA addon to integrate with EDA event streams. EDA event streams allow for token based authentication as well as storing a history of events. 

[quote]
 üõë Do not actually configure, this section is for reference only

Step1: Access the Ansible addon

image::eda_addon.png[Add on, 100%]

Step2: Create a webhook to EDA event-stream configuration:

image::example_event-stream.png[example, 150%]

Step3: Return to Edit Alert

image::return_edit_alert.png[return, 100%]

=== Router State (Returning to the Lab)
Here we need to return the router's OPSF neighbor to a steady state.

Step1: Return the OPSF neighbor to a full adjacency

Access cisco-rtr1 from the bastion console to no shut interface tunnel0

image::bastion.png[bastion, 150%]

* SSH password=`{ssh_password}` 
* SSH into cisco-rtr1 and add the following commands

[source, BASH] 
----
ssh admin@cisco-rtr1
config t
int tu 0
no shut
----

== Summary

The Cisco router and Splunk are ‚öôÔ∏è configured to observe and create alerts for OSPF neighbor down states. 

== Complete

You have completed this module. Move forward to the next section to ‚öôÔ∏èconfigure the Ansible EDA controller.
